name: Production Smoke Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
  schedule:
    - cron: '*/30 * * * *' # Run endpoint checks every 30 minutes
    - cron: '0 3 * * *'    # Run full E2E smoke tests nightly at 3 AM UTC

jobs:
  # Quick endpoint verification (runs every 30 min)
  endpoint-checks:
    name: Verify Production Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Only run on schedule (every 30 min) or manual trigger
    if: github.event_name != 'pull_request'

    steps:
      - name: Check UI Homepage
        run: |
          echo "Testing UI endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://applylens.app/)
          echo "UI response: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå UI endpoint failed with status $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ UI endpoint OK"

      - name: Check API Ready Endpoint
        run: |
          echo "Testing API /ready endpoint..."
          RESPONSE=$(curl -s https://applylens.app/api/ready)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://applylens.app/api/ready)
          echo "API response: $HTTP_CODE"
          echo "API body: $RESPONSE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå API endpoint failed with status $HTTP_CODE"
            exit 1
          fi

          # Verify JSON response contains expected fields
          if echo "$RESPONSE" | grep -q '"status":"ready"'; then
            echo "‚úÖ API endpoint OK"
          else
            echo "‚ùå API response missing expected status field"
            exit 1
          fi

      - name: Check API Health Endpoint
        run: |
          echo "Testing API /healthz endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://applylens.app/api/healthz)
          echo "Health response: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Health endpoint failed with status $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Health endpoint OK"

      - name: Check Response Time
        run: |
          echo "Measuring response time..."
          TIME=$(curl -s -o /dev/null -w "%{time_total}" https://applylens.app/)
          echo "Response time: ${TIME}s"

          # Alert if response > 5 seconds (but don't fail)
          if (( $(echo "$TIME > 5.0" | bc -l) )); then
            echo "‚ö†Ô∏è  Warning: Slow response time (${TIME}s > 5s threshold)"
          else
            echo "‚úÖ Response time acceptable"
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "üö® Production smoke test FAILED!"
          echo "Check https://applylens.app for issues"

  # Full E2E tests with @prodSafe tag (runs nightly or manual)
  e2e-smoke-tests:
    name: Run @prodSafe E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run on nightly schedule (3 AM) or manual trigger
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '0 3 * * *')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: apps/web
        run: pnpm exec playwright install --with-deps chromium

      - name: Check for prod storage state
        id: check_state
        working-directory: apps/web
        run: |
          if [ ! -f "tests/.auth/prod.json" ]; then
            echo "‚ùå prod.json not found!"
            echo "Please create it with: pnpm exec tsx tests/setup/save-prod-state.ts"
            exit 1
          fi
          echo "‚úì prod.json exists"

      - name: Run @prodSafe tests on production
        working-directory: apps/web
        env:
          E2E_BASE_URL: https://applylens.app
          CI: "1"
        run: pnpm test:e2e

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-prod-smoke
          path: apps/web/playwright-report/
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-prod-smoke
          path: apps/web/test-results/
          retention-days: 7

      - name: Comment on success
        if: success()
        run: |
          echo "‚úÖ Production smoke tests passed!"
          echo "All @prodSafe tests ran successfully in read-only mode."

      - name: Comment on failure
        if: failure()
        run: |
          echo "‚ùå Production smoke tests failed!"
          echo "Check the uploaded artifacts for details."
