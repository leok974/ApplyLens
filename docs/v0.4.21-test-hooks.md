# v0.4.21 Test Hooks Implementation

## Overview

Added safe-for-production test hooks to verify UX polish features:
- Derived subject detection
- Scoring tooltip visibility

## Changes Made

### 1. Test Hooks in Code (Safe for Production)

#### `apps/web/src/lib/searchMap.ts`
Added `derived` flag to track when subjects are derived vs original:

```typescript
export function mapHit(hit: RawHit) {
  const source = hit._source ?? hit;

  // Track if subject was originally missing (for test hooks)
  const hadSubject = !!(source.subject_highlight ?? source.subject ?? "").trim();
  const subject = deriveSubject(source);

  return {
    id: String(source.id ?? source.gmail_id ?? source._id ?? ""),
    subject,
    snippet: source.snippet ?? source.preview ?? source.body_preview ?? "",
    from: source.from_email ?? source.from_addr ?? source.sender ?? source.from ?? "",
    date: source.received_at ?? source.sent_at ?? source.date ?? null,
    score: source.score ?? undefined,
    // ... other fields
    derived: !hadSubject, // <-- Test hook: true if subject was derived
    _raw: hit,
  };
}
```

#### `apps/web/src/pages/Search.tsx`
Added test IDs to subject elements:

```tsx
<h3
  data-testid="result-subject"
  data-derived={h.derived ? "1" : "0"}  // <-- Test hook
  className="font-semibold leading-snug text-[color:hsl(var(--foreground))]"
  dangerouslySetInnerHTML={toMarkedHTML(h.subject)}
/>
```

#### `apps/web/src/components/SearchResultsHeader.tsx`
Added test IDs for header and tooltip:

```tsx
<div className="mb-3 flex items-center justify-between" data-testid="results-header">
  {/* ... */}
  <Badge
    variant="outline"
    className="gap-1 cursor-default"
    data-testid="scoring-pill"  // <-- Test hook
  >
    <Info className="h-3 w-3" />
    Scoring
  </Badge>
```

### 2. E2E Test Spec

#### `apps/web/tests/e2e/search-derived-and-tooltip.spec.ts`

```typescript
import { test, expect } from "@playwright/test";

const base = process.env.E2E_BASE_URL || "http://localhost:5175";

test.describe("Search – derived subjects & scoring tooltip", () => {
  test.beforeEach(async ({ page }) => {
    // Load wildcard search which lists everything
    await page.goto(`${base}/search?q=*`);
    // Wait until results list appears
    await page.getByTestId("results-list").waitFor({ state: "visible", timeout: 10000 });
  });

  test("renders a derived subject when original subject is missing", async ({ page }) => {
    // Find any subject with data-derived="1"
    const derived = page.locator('[data-testid="result-subject"][data-derived="1"]').first();
    const isVisible = await derived.isVisible().catch(() => false);
    if (!isVisible) {
      test.skip(true, "No derived subjects present in current dataset");
    }

    const text = (await derived.textContent())?.trim() || "";
    expect(text.length).toBeGreaterThan(0);
    expect(text.toLowerCase()).not.toContain("(no subject)");
  });

  test("results header shows total and query", async ({ page }) => {
    const header = page.getByTestId("results-header");
    await expect(header).toBeVisible();
    const text = (await header.textContent()) || "";
    expect(text).toMatch(/Results/i);
    expect(text).toMatch(/for/i);
  });

  test("scoring tooltip appears on hover", async ({ page }) => {
    const pill = page.getByTestId("scoring-pill");
    await expect(pill).toBeVisible();

    await pill.hover();
    const tooltip = page.locator("[role='tooltip']");
    await expect(tooltip).toBeVisible({ timeout: 2000 });

    // sanity: check some of the content
    await expect(tooltip).toContainText(/Boosts:/i);
    await expect(tooltip).toContainText(/offer ×4/i);
    await expect(tooltip).toContainText(/Gaussian/i);
  });

  test("scoring tooltip appears on keyboard focus (a11y)", async ({ page }) => {
    const pill = page.getByTestId("scoring-pill");
    await pill.focus();
    const tooltip = page.locator("[role='tooltip']");
    await expect(tooltip).toBeVisible({ timeout: 2000 });
  });
});
```

### 3. Playwright Configuration

Added test to `playwright.config.ts`:

```typescript
testMatch: [
  // ... existing tests
  "e2e/search-derived-and-tooltip.spec.ts",  // <-- New test
  // ... more tests
],
```

## Running the Tests

### Local Development

```bash
cd apps/web
npm run test:e2e -- e2e/search-derived-and-tooltip --reporter=list
```

### Against Production/Staging

```bash
# Set the base URL first
export E2E_BASE_URL="https://applylens.app"  # or your staging URL

# Run the tests
cd apps/web
npm run test:e2e -- e2e/search-derived-and-tooltip --reporter=list
```

### PowerShell (Windows)

```powershell
cd apps/web
$env:E2E_BASE_URL="http://localhost"  # or your target URL
npm run test:e2e -- e2e/search-derived-and-tooltip --reporter=list
```

## Test Coverage

The spec validates:

1. **Derived Subjects**: Checks if emails with missing subjects show derived text from body/snippet
   - Gracefully skips if all emails in dataset have subjects
   - Verifies derived text is not "(no subject)" or empty

2. **Results Header**: Confirms header displays result count and query
   - Tests basic visibility and content

3. **Tooltip on Hover**: Verifies scoring pill shows tooltip on mouse hover
   - Checks tooltip content includes expected scoring details
   - Validates shadcn/ui tooltip component integration

4. **Tooltip on Focus**: Ensures keyboard accessibility
   - Tests focus event triggers tooltip
   - A11y compliance check

## Production Safety

All test hooks use standard HTML attributes that are safe in production:
- `data-testid`: Standard testing attribute, ignored by browsers
- `data-derived`: Custom data attribute, no impact on functionality
- No performance impact (simple boolean flag)
- No visual changes (attributes are invisible to users)

## Files Modified

- ✅ `apps/web/src/lib/searchMap.ts` - Added `derived` flag
- ✅ `apps/web/src/pages/Search.tsx` - Added test IDs to subject elements
- ✅ `apps/web/src/components/SearchResultsHeader.tsx` - Added test IDs to header and pill
- ✅ `apps/web/tests/e2e/search-derived-and-tooltip.spec.ts` - New test spec
- ✅ `apps/web/playwright.config.ts` - Added test to match list

## Next Steps

1. **Build and Deploy**:
   ```bash
   cd apps/web
   docker build -t leoklemet/applylens-web:v0.4.21 -f Dockerfile.prod .
   docker-compose -f docker-compose.prod.yml up -d --force-recreate web
   docker-compose -f docker-compose.prod.yml restart nginx
   ```

2. **Run Tests**:
   - Ensure API and database are running
   - Run the test suite as shown above
   - Expected: 4 passing tests (or 1 skip + 3 pass if no derived subjects)

3. **CI/CD Integration** (optional):
   - Add to GitHub Actions workflow
   - Run on every PR to main
   - Block merge if tests fail

## Notes

- **Graceful Degradation**: The "derived subject" test skips if dataset has no missing subjects
- **Tooltip Testing**: Uses Radix UI's `role='tooltip'` for stable selector
- **A11y**: Keyboard focus test ensures accessibility compliance
- **No Visual Regression**: All changes are pure test infrastructure

---

**Version**: v0.4.21-test-hooks
**Status**: ✅ Implemented, pending deployment test
**Author**: GitHub Copilot
**Date**: October 24, 2025
