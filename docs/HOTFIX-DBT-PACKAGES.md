# Hotfix: dbt Packages Configuration

**Date:** 2025-10-17  
**Issue:** GitHub Actions workflow failing with "packages.yml is malformed" error  
**Status:** ✅ RESOLVED

> **⚠️ DO NOT COMMIT dbt Build Artifacts**
>
> The following files are generated by dbt and should **NEVER** be committed:
> - `analytics/dbt/dbt_packages/` - installed dependencies
> - `analytics/dbt/target/` - compiled models
> - `analytics/dbt/logs/` - execution logs
> - `analytics/dbt/package-lock.yml` - resolved versions
> - `analytics/dbt/manifest.json` - catalog metadata
> - `analytics/dbt/run_results.json` - execution results
> - `analytics/dbt/catalog.json` - documentation data
>
> These are now blocked by pre-commit hooks and .gitignore.

## Problem

After merging PR #12, the GitHub Actions "Warehouse Nightly" workflow started failing during `dbt deps` with the error:

```
Runtime Error
  The packages.yml file in this project is malformed. Please double check
  the contents of this file and fix any errors before retrying.

  Validator Error:
  ***'name': 'dbt_utils', 'package': 'dbt-labs/dbt_utils', 'version': '1.3.1', 'unrendered': ***'name': 'dbt_utils', 'package': 'dbt-labs/dbt_utils', 'version': '1.3.1'*** is not valid under any of the given schemas
```

## Root Cause

Two issues were identified:

### 1. Tracked `dbt_packages/` Directory (Primary Issue)
The `dbt_packages/` directory (221 files) was accidentally committed to git during PR #12. This directory should be:
- **Generated** by `dbt deps` (not committed)
- **Ignored** by .gitignore
- **Excluded** from version control

When GitHub Actions ran `dbt deps`, it encountered conflicts between the committed files and the packages it tried to install, resulting in a malformed `package-lock.yml` with an `'unrendered'` field that dbt 1.8 doesn't recognize.

### 2. Version Range Syntax (Secondary Issue)
The `packages.yml` used version ranges:
```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: [">=1.3.0", "<2.0.0"]  # Version range
  - package: calogica/dbt_date
    version: [">=0.10.0", "<1.0.0"]  # Version range
```

While dbt 1.11 (local) handles version ranges fine, dbt 1.8 (GitHub Actions) had issues with them in combination with the tracked packages.

## Solution

### Fix 1: Add dbt .gitignore and Remove Tracked Packages
**Commit:** `286de14`

Created `analytics/dbt/.gitignore`:
```gitignore
# dbt artifacts
target/
dbt_packages/
logs/
.user.yml
package-lock.yml

# Python
__pycache__/
*.py[cod]
*.egg-info/
.venv/
venv/
*.so

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db
```

Removed all tracked files:
```bash
git rm -r --cached analytics/dbt/dbt_packages/
git add analytics/dbt/.gitignore
git commit -m "Add dbt .gitignore and remove tracked dbt_packages"
```

**Result:** 222 files changed, 25 insertions(+), 10,396 deletions(-)

### Fix 2: Pin Exact Package Versions
**Commit:** `81ab294`

Changed `packages.yml` to use exact versions:
```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: 1.3.1
  - package: calogica/dbt_date
    version: 0.10.1
```

**Rationale:**
- Ensures consistent behavior across dbt versions
- Avoids dbt 1.8 version range parsing issues
- Provides deterministic builds

## Verification

### Failed Runs (Before Fix)
- Run #18580610505: Failed at "Install dbt packages" (43s)
- Run #18581083220: Failed at "Install dbt packages" (39s)

### Successful Run (After Fix)
- Run #18581111961: ✅ SUCCESS (1m31s)
  - dbt deps: ✅ Packages installed
  - dbt run: ✅ 6 models built
  - dbt test: ✅ 31 tests passed
  - dbt docs: ✅ Generated
  - ES validation: Skipped (default)

**GitHub Actions URL:** https://github.com/leok974/ApplyLens/actions/runs/18581111961

## Prevention

### For Future dbt Projects
1. **Always** create `dbt_packages/` in `.gitignore` from day one
2. **Never** commit `dbt_packages/`, `target/`, or `package-lock.yml`
3. **Pin** exact package versions when using CI/CD with different dbt versions
4. **Test** locally with the same dbt version as CI (or use version ranges cautiously)

### Repository Status
```bash
# Check what's tracked in git
git ls-files analytics/dbt/dbt_packages/  # Should return nothing

# Check .gitignore
cat analytics/dbt/.gitignore  # Should include dbt_packages/

# Verify clean state
git status  # Should show dbt_packages/ as untracked (or not at all if empty)
```

## Lessons Learned

1. **dbt 1.8 vs 1.11 Differences:**
   - Version range syntax handling
   - package-lock.yml format expectations
   - Always test with production dbt version

2. **Git Hygiene:**
   - Generated artifacts should never be committed
   - .gitignore should be comprehensive from the start
   - Review PR diffs carefully (24,757 insertions should have raised a flag)

3. **CI/CD Best Practices:**
   - Pin versions for reproducibility
   - Test workflow changes before merging large PRs
   - Use exact versions when possible

## Related Issues

- **PR #12:** "Housekeeping & 15-min sync + small improvements"
  - Accidentally included dbt_packages/ (221 files)
  - Fixed in subsequent commits
- **dbt-bigquery version:** 1.8.* (pinned in workflow)
- **Local dbt version:** 1.11.0-b3 (worked fine locally)

## Status

✅ **RESOLVED** - Workflow now passing consistently

**Next Smoke Test:** Scheduled nightly run at 4:17 AM UTC  
**Manual Trigger:** `gh workflow run "Warehouse Nightly"`

## Additional Hardening (2025-10-17)

To prevent future regressions, the following bulletproofing measures were added:

### 1. Belt-and-Suspenders .gitignore
**Root `.gitignore` additions:**
```gitignore
# dbt Build Artifacts (DO NOT COMMIT)
analytics/dbt/target/
analytics/dbt/dbt_packages/
analytics/dbt/logs/
analytics/dbt/package-lock.yml
analytics/dbt/manifest.json
analytics/dbt/run_results.json
analytics/dbt/catalog.json
```

### 2. CI Clean Deps Step
**Workflow change:** `.github/workflows/dbt.yml`
```yaml
- name: Clean dbt deps
  working-directory: analytics/dbt
  run: |
    rm -rf dbt_packages package-lock.yml

- name: Install dbt packages
  working-directory: analytics/dbt
  run: dbt deps --target prod
```
Guarantees fresh resolution on every CI run, prevents drift.

### 3. Exact Version Pins
**Workflow change:**
```yaml
pip install "dbt-core==1.8.5" "dbt-bigquery==1.8.5"
```
**packages.yml (already done):**
```yaml
- package: dbt-labs/dbt_utils
  version: 1.3.1  # exact, not ">=1.3.0"
- package: calogica/dbt_date
  version: 0.10.1  # exact, not ">=0.10.0"
```

### 4. Pre-Commit Guard
**File:** `.pre-commit-config.yaml`
```yaml
- repo: local
  hooks:
    - id: no-dbt-artifacts
      name: block dbt build artifacts
      entry: bash -c 'git diff --cached --name-only | grep -E "analytics/dbt/(dbt_packages|target|package-lock\.yml|logs|manifest\.json|run_results\.json|catalog\.json)" && echo "❌ Do not commit dbt artifacts. Run: git reset HEAD <file>" && exit 1 || exit 0'
      language: system
```

**Enable locally:**
```bash
pip install pre-commit
pre-commit install
```

### 5. Sanity Check Scripts
**New scripts:**
- `analytics/ops/dbt-sanity-check.ps1` (Windows/PowerShell)
- `analytics/ops/dbt-sanity-check.sh` (Linux/Mac/Bash)

**Usage:**
```bash
# From repo root
./analytics/ops/dbt-sanity-check.sh

# Verifies:
# ✅ dbt_packages/ not tracked in git
# ✅ .gitignore patterns present
# ✅ packages.yml uses pinned versions
# ✅ Clean + fresh dbt deps
# ✅ Optional: local dbt run + test
```

### 6. Documentation Updates
- **CONTRIBUTING.md:** Added "Do Not Commit" section
- **HOTFIX-DBT-PACKAGES.md:** Added warning box at top

---

**Created:** 2025-10-17 03:10 UTC  
**Hardened:** 2025-10-17 03:30 UTC  
**Author:** GitHub Copilot  
**Commits:** 286de14, 81ab294, [hardening commits]
