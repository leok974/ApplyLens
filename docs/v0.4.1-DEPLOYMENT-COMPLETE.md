# 🎯 ApplyLens v0.4.1 - Versioned Deployment Complete

**Date:** October 23, 2025
**Git SHA:** 461336d
**Status:** ✅ Successfully Deployed

---

## 🚀 What Was Implemented

### 1. Versioned Image System
- **Tagged builds:** Both API and Web now use `v0.4.1` semantic versioning
- **Immutable digests:** SHA256 digests available for rock-solid pinning
- **OCI metadata:** All images include git SHA, build date, and source URL

### 2. Build Automation
**Script:** `scripts/build-and-tag.ps1`
- Builds both services with version tags
- Auto-adds git commit SHA and build timestamp
- Supports selective builds (API or Web only)
- Optional registry push
- Shows digests for immutable deployment

### 3. Rollback Automation
**Script:** `scripts/rollback.ps1`
- 30-second rollback to any previous version
- Automatic backup of docker-compose.prod.yml
- Health check verification
- Auto-rollback on failure
- Dry-run mode for safety testing

### 4. Docker Build Enhancements
**Both Dockerfiles Updated:**
- Added `ARG GIT_SHA` and `ARG BUILD_DATE`
- OCI labels for provenance tracking
- Metadata viewable via `docker inspect`

### 5. Documentation
- **Full guide:** `docs/DEPLOYMENT.md` (comprehensive 400+ lines)
- **Quick ref:** `DEPLOY-QUICK-REF.md` (one-liner commands)
- **Scripts guide:** `scripts/README.md` (automation docs)

---

## 📦 Current Production State

### Images
```
API:  leoklemet/applylens-api:v0.4.1
      Size: 998MB
      SHA256: 99a07206dfb3987c7c8f3775af0f61a405b298d4db54c9877ac567528ab1bc7a

Web:  leoklemet/applylens-web:v0.4.1
      Size: 83.4MB
      SHA256: f069ea49758048488766ee191b423b27bb4d8c02920084d0154aca560772d61e
```

### Containers
```
✅ applylens-api-prod  → v0.4.1 (healthy, up 3 minutes)
✅ applylens-web-prod  → v0.4.1 (healthy, up 3 minutes)
✅ All 19 containers running
```

### Endpoints Verified
```
✅ http://localhost:8003/healthz          → {"status":"ok"}
✅ http://localhost:5175/                 → 200 OK
✅ http://localhost:5175/api/ux/heartbeat → {"ok":true}
✅ http://localhost:5175/api/ux/chat/opened → {"ok":true}
```

---

## 🎓 Usage Examples

### Deploy New Version
```powershell
# 1. Build
.\scripts\build-and-tag.ps1 -Version "v0.4.2"

# 2. Update docker-compose.prod.yml
#    Change: image: leoklemet/applylens-api:v0.4.1
#    To:     image: leoklemet/applylens-api:v0.4.2

# 3. Deploy
docker-compose -f docker-compose.prod.yml up -d --force-recreate api web

# 4. Verify
curl http://localhost:8003/healthz
```

### Instant Rollback
```powershell
# Rollback to v0.4.1 (30 seconds)
.\scripts\rollback.ps1 -Version "v0.4.1"

# Rollback with safety check first
.\scripts\rollback.ps1 -Version "v0.4.1" -DryRun
.\scripts\rollback.ps1 -Version "v0.4.1"
```

### View Image Provenance
```powershell
# See what's running
docker ps --filter "name=applylens-" --format "{{.Names}}\t{{.Image}}"

# Check git SHA and build date
docker inspect leoklemet/applylens-api:v0.4.1 --format='Git: {{index .Config.Labels "org.opencontainers.image.revision"}}, Built: {{index .Config.Labels "org.opencontainers.image.created"}}'
```

---

## 🔒 Immutable Deployment (Advanced)

For maximum security, use SHA256 digests instead of tags:

### Current Digests
```yaml
# In docker-compose.prod.yml
api:
  image: leoklemet/applylens-api@sha256:99a07206dfb3987c7c8f3775af0f61a405b298d4db54c9877ac567528ab1bc7a

web:
  image: leoklemet/applylens-web@sha256:f069ea49758048488766ee191b423b27bb4d8c02920084d0154aca560772d61e
```

**Benefits:**
- Content-addressable (can't be overwritten)
- Prevents tag hijacking
- Audit trail for compliance
- Guaranteed reproducibility

---

## 📊 Deployment Comparison

### Before (v0.4.0)
- ❌ Using `:latest` tags (mutable, no rollback)
- ❌ Manual build commands (error-prone)
- ❌ No image metadata
- ❌ No rollback procedure
- ❌ No deployment docs

### After (v0.4.1)
- ✅ Semantic versioning (`v0.4.1`)
- ✅ Automated build scripts
- ✅ OCI metadata (git SHA, build date)
- ✅ 30-second automated rollback
- ✅ Comprehensive documentation
- ✅ Immutable digest option
- ✅ Dry-run safety checks

---

## 🛠️ What Changed in v0.4.1

### API (`services/api/`)
- ✅ CSRF exemptions for `/ux/heartbeat` and `/ux/chat/opened`
- ✅ Added OCI metadata labels to Dockerfile.prod
- ✅ Fixed production 403/422 errors

### Web (`apps/web/`)
- ✅ Fixed heartbeat payload format
- ✅ Added OCI metadata labels to Dockerfile.prod
- ✅ Resolved UX metrics failures

### Infrastructure
- ✅ Versioned `docker-compose.prod.yml` (API + Web)
- ✅ Build automation script
- ✅ Rollback automation script
- ✅ Deployment documentation

---

## 📝 Files Added/Modified

### New Files
```
✅ scripts/build-and-tag.ps1        - Build automation
✅ scripts/rollback.ps1              - Rollback automation
✅ scripts/README.md                 - Scripts documentation
✅ docs/DEPLOYMENT.md                - Full deployment guide (400+ lines)
✅ DEPLOY-QUICK-REF.md               - Quick reference card
✅ docs/v0.4.1-DEPLOYMENT-COMPLETE.md - This summary
```

### Modified Files
```
✅ docker-compose.prod.yml           - Versioned images (v0.4.1)
✅ apps/web/Dockerfile.prod          - Added OCI labels
✅ services/api/Dockerfile.prod      - Added OCI labels
```

---

## 🎯 Quick Commands

```powershell
# Build new version
.\scripts\build-and-tag.ps1 -Version "v0.4.2"

# Deploy
docker-compose -f docker-compose.prod.yml up -d --force-recreate api web

# Rollback
.\scripts\rollback.ps1 -Version "v0.4.1"

# Verify
curl http://localhost:8003/healthz

# View metadata
docker inspect leoklemet/applylens-api:v0.4.1 --format='{{json .Config.Labels}}'

# List versions
docker images | grep applylens
```

---

## 🚨 Emergency Procedures

### Complete Outage
```powershell
# 1. Check all containers
docker ps -a --filter "name=applylens-"

# 2. Check logs
docker logs applylens-api-prod --tail 100
docker logs applylens-web-prod --tail 100

# 3. Restart all services
docker-compose -f docker-compose.prod.yml restart

# 4. Nuclear option (recreate everything)
docker-compose -f docker-compose.prod.yml up -d --force-recreate
```

### Bad Deployment
```powershell
# Immediate rollback to v0.4.1
.\scripts\rollback.ps1 -Version "v0.4.1"

# Or manual
Copy-Item docker-compose.prod.yml.bak docker-compose.prod.yml
docker-compose -f docker-compose.prod.yml up -d --force-recreate api web
```

---

## 📈 Next Steps (Optional Enhancements)

### 1. CI/CD Pipeline
- GitHub Actions workflow for automated builds
- Auto-tag on merge to `main`
- Auto-deploy to staging environment

### 2. Monitoring
- Grafana dashboard for deployment tracking
- Prometheus metrics for rollback frequency
- Alert on failed health checks

### 3. Registry Management
- Automated cleanup of old images (keep last 5)
- Registry webhooks for deployment notifications
- Image vulnerability scanning

### 4. Multi-Environment
- Staging environment with separate compose file
- Blue-green deployment strategy
- Canary releases for gradual rollout

---

## 🎉 Success Criteria

All objectives completed:

- ✅ Versioned images built and deployed
- ✅ Docker compose pinned to v0.4.1
- ✅ Rollback scripts tested and working
- ✅ Immutable digests documented
- ✅ Build automation in place
- ✅ Comprehensive documentation
- ✅ All health checks passing
- ✅ UX endpoints working
- ✅ Production errors resolved (403/422)

---

## 📚 Documentation Index

1. **Quick Start:** `DEPLOY-QUICK-REF.md`
2. **Full Guide:** `docs/DEPLOYMENT.md`
3. **Scripts:** `scripts/README.md`
4. **This Summary:** `docs/v0.4.1-DEPLOYMENT-COMPLETE.md`

---

## 🙏 Acknowledgments

**Implemented:** October 23, 2025
**Version:** v0.4.1
**Git SHA:** 461336d

**Features:**
- Semantic versioning
- Automated builds
- Instant rollback
- OCI metadata
- Immutable deploys

**Status:** ✅ Production Ready

---

*Lock it in. Roll back instantly. Deploy with confidence.* 🚀
