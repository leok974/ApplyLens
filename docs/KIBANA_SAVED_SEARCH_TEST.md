# Kibana Saved Search - Test Email Verification

## Overview

This saved search provides quick verification of v3.1 test email fixtures, filtering for high-risk emails (suspicion_score ‚â• 40) on the test index `gmail_emails-999999`.

## What's Included

**File**: `infra/kibana/test_high_risk_saved_search.ndjson`

Contains:
1. **Data View**: `gmail_emails-999999` (points to test index)
2. **Saved Search**: "ApplyLens ‚Äî Test Emails (High Risk ‚â•40)"
   - Query: `suspicion_score >= 40`
   - Columns: `received_at`, `from`, `subject`, `suspicion_score`
   - Sort: `received_at` descending

## Import Instructions

### Prerequisites

- Kibana running on `http://localhost:5601/kibana`
- Elasticsearch credentials (default: `elastic:elasticpass`)
- Test emails generated via `scripts/generate_test_emails.py`

### Option 1: PowerShell (Windows)

```powershell
$KBN = "http://localhost:5601/kibana"
$AUTH = "elastic:elasticpass"
$enc = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes($AUTH))
$boundary = [Guid]::NewGuid().ToString()
$LF = "`r`n"
$blob = Get-Content "infra/kibana/test_high_risk_saved_search.ndjson" -Raw
$body = "--$boundary$LF" +
"Content-Disposition: form-data; name=`"file`"; filename=`"test_high_risk_saved_search.ndjson`"$LF" +
"Content-Type: application/ndjson$LF$LF" +
$blob + "$LF--$boundary--$LF"

Invoke-RestMethod -Uri "$KBN/api/saved_objects/_import?createNewCopies=false" `
  -Method POST `
  -Headers @{ "kbn-xsrf"="true"; "Authorization"="Basic $enc"; "Content-Type"="multipart/form-data; boundary=$boundary" } `
  -Body $body
```

Expected output:
```json
{
  "success": true,
  "successCount": 2,
  "successResults": [
    {
      "type": "index-pattern",
      "id": "applylens-test-gmail-999999",
      "meta": { "title": "gmail_emails-999999" }
    },
    {
      "type": "search",
      "id": "applylens-test-highrisk",
      "meta": { "title": "ApplyLens ‚Äî Test Emails (High Risk ‚â•40)" }
    }
  ]
}
```

### Option 2: Bash (macOS/Linux)

```bash
KBN="http://localhost:5601/kibana"
AUTH="elastic:elasticpass"
curl -s -u "$AUTH" -H "kbn-xsrf: true" \
  -F "file=@infra/kibana/test_high_risk_saved_search.ndjson;type=application/ndjson" \
  "$KBN/api/saved_objects/_import?createNewCopies=false" | jq
```

### Option 3: Kibana UI (Manual Import)

1. Navigate to **Stack Management** ‚Üí **Saved Objects**
2. Click **Import**
3. Select `infra/kibana/test_high_risk_saved_search.ndjson`
4. Check "Automatically overwrite conflicts"
5. Click **Import**

## Usage

### Open in Kibana

1. Go to **Analytics** ‚Üí **Discover**
2. In the **Data View** dropdown, select `gmail_emails-999999`
3. Click **Open** ‚Üí **Saved searches**
4. Select **"ApplyLens ‚Äî Test Emails (High Risk ‚â•40)"**

### Expected Results

You should see test emails with high risk scores:

| received_at | from | subject | suspicion_score |
|-------------|------|---------|-----------------|
| 2024-10-21T15:30:00Z | suspicious@newdomain.com | URGENT: Brand Action Required | 105 |
| 2024-10-21T15:25:00Z | noreply@spoof-bank.net | Your Account Suspended | 55 |
| 2024-10-21T15:20:00Z | hr@offbrand-company.org | Important: Tax Forms | 50 |

**Test cases shown** (generated by `generate_test_emails.py`):
- ‚úÖ **tc1-brand-mismatch** (105+ pts) - Brand mention + non-canonical domain + risky phrases
- ‚úÖ **tc3-spf-dmarc-fail** (40+ pts) - SPF/DKIM/DMARC failures
- ‚úÖ **tc4-shortener-anchor-mismatch** (30+ pts) - URL shorteners + anchor mismatch
- ‚úÖ **tc5-risky-attachments** (20+ pts) - Executable/macro attachments
- ‚úÖ **tc6-young-domain** (30+ pts with enrichment) - Newly registered domain

**Not shown** (below threshold):
- ‚ùå **tc2-replyto-mismatch** (15 pts) - Reply-To domain differs
- ‚ùå **tc7-ok-control** (0 pts) - Clean corporate email

## Verification

### Check Saved Object via API

```bash
curl -s -u elastic:elasticpass \
  "http://localhost:5601/kibana/api/saved_objects/search/applylens-test-highrisk" \
  -H "kbn-xsrf: true" | jq '.attributes.title, .attributes.kibanaSavedObjectMeta.searchSourceJSON'
```

Expected output:
```json
"ApplyLens ‚Äî Test Emails (High Risk ‚â•40)"
"{\"query\":{\"query\":\"suspicion_score >= 40\",\"language\":\"kuery\"},\"filter\":[],\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\"}"
```

### Check Data View

```bash
curl -s -u elastic:elasticpass \
  "http://localhost:5601/kibana/api/saved_objects/index-pattern/applylens-test-gmail-999999" \
  -H "kbn-xsrf: true" | jq '.attributes.title, .attributes.timeFieldName'
```

Expected output:
```json
"gmail_emails-999999"
"received_at"
```

### Count High Risk Emails

```bash
curl -s -u elastic:elasticpass \
  "http://localhost:9200/gmail_emails-999999/_count?q=suspicion_score:>=40" | jq '.count'
```

Expected: 5-6 emails (depending on domain enrichment status)

## Customization

### Adjust Risk Threshold

To change the threshold from 40 to another value:

1. Open the saved search in Kibana Discover
2. Edit the query: `suspicion_score >= 60` (for high confidence)
3. Click **Save** ‚Üí **Save as new** ‚Üí Name it "ApplyLens ‚Äî Test Emails (High Risk ‚â•60)"

### Add More Columns

Common additional columns:
- `suspicious` (boolean flag)
- `explanations` (reasons for flagging)
- `suggested_actions` (user recommendations)
- `verify_checks` (validation steps)

To add columns:
1. Click **Add field** in the left sidebar
2. Select fields from the list
3. Click **Save** to update the saved search

## Troubleshooting

### "Index pattern not found"

**Problem**: Data view `gmail_emails-999999` doesn't exist

**Solution**: Generate test emails first:
```bash
python scripts/generate_test_emails.py
```

### "No results found"

**Problem**: No emails match `suspicion_score >= 40`

**Solution**:
1. Check if test emails exist: `curl http://localhost:9200/gmail_emails-999999/_count`
2. Check suspicion scores: `curl http://localhost:9200/gmail_emails-999999/_search?size=10 | jq '.hits.hits[]._source | {id, suspicion_score}'`
3. Lower threshold temporarily: `suspicion_score >= 10`

### "Import failed: Conflict"

**Problem**: Data view or saved search already exists

**Solution**:
```bash
# Delete existing objects
curl -X DELETE -u elastic:elasticpass \
  "http://localhost:5601/kibana/api/saved_objects/search/applylens-test-highrisk" \
  -H "kbn-xsrf: true"

curl -X DELETE -u elastic:elasticpass \
  "http://localhost:5601/kibana/api/saved_objects/index-pattern/applylens-test-gmail-999999" \
  -H "kbn-xsrf: true"

# Re-import
# ... (use import command from above)
```

Or use `createNewCopies=true` in import URL:
```powershell
Invoke-RestMethod -Uri "$KBN/api/saved_objects/_import?createNewCopies=true" ...
```

### "Authentication failed"

**Problem**: Incorrect Elasticsearch credentials

**Solution**: Update `$AUTH` variable with your credentials:
```powershell
$AUTH = "your_username:your_password"
```

Or check your Elasticsearch configuration:
```bash
curl http://localhost:9200 -u elastic:elasticpass
```

## Related Documentation

- **Test Email Generator**: `docs/TEST_EMAIL_GENERATOR.md`
- **v3.1 Implementation**: `docs/EMAIL_RISK_V3.1_SUMMARY.md`
- **Domain Enrichment**: `docs/DOMAIN_ENRICHMENT_WORKER.md`
- **E2E Tests**: `apps/web/tests/e2e/README-email-risk.md`

## Next Steps

1. ‚úÖ Import saved search (see above)
2. ‚úÖ Open in Kibana Discover
3. ‚úÖ Verify high-risk test cases visible
4. ‚è≥ Create production saved search for `gmail_emails` index
5. ‚è≥ Build Kibana dashboards with Lens visualizations
6. ‚è≥ Export additional saved searches (Reply-To mismatches, shorteners, attachments)

## Production Saved Search (Future)

To create a production version for the main `gmail_emails` index:

1. Duplicate `test_high_risk_saved_search.ndjson` to `prod_high_risk_saved_search.ndjson`
2. Replace:
   - `gmail_emails-999999` ‚Üí `gmail_emails`
   - `applylens-test-gmail-999999` ‚Üí `applylens-prod-gmail`
   - `applylens-test-highrisk` ‚Üí `applylens-prod-highrisk`
   - Title: "ApplyLens ‚Äî Production Emails (High Risk ‚â•40)"
3. Import using same procedure

---

**Status**: üü¢ **Ready to Import**
**File**: `infra/kibana/test_high_risk_saved_search.ndjson`
