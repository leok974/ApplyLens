# v0.4.32 Deployment - Settings & Adaptive Classification

**Deployed:** October 25, 2025
**Focus:** Sender overrides management + adaptive classification feedback loop + insights panel

---

## 🎯 Overview

This release adds persistent sender override management, enabling users to control which senders are muted or trusted. The system now learns from "Mark Safe" actions to avoid re-flagging trusted senders in the future.

---

## 📦 What's New

### 1. Sender Overrides API (`services/api/app/routers/senders.py`)

New REST API for managing sender preferences:

```python
GET /api/settings/senders
POST /api/settings/senders/mute
POST /api/settings/senders/safe
DELETE /api/settings/senders/:id
```

**Data Model:**
```python
class SenderOverride:
    id: str
    sender: str           # email address or domain
    muted: bool           # auto-archive future emails
    safe: bool            # trusted sender, won't flag
    created_at: str
    updated_at: str | None
```

**Storage:** In-memory dict (to be migrated to Postgres in future)

### 2. Adaptive Classification

**Updated:** `mark_safe` endpoint in `inbox_actions.py`

When user marks an email as safe:
1. ✅ Archives the email (existing behavior)
2. ✅ Lowers risk score to 5 (existing behavior)
3. 🆕 **Records sender-level override** (new!)

```python
# After marking safe, record override
if sender_email:
    await upsert_sender_override(
        user_email=user_email,
        sender=sender_email,
        muted=False,
        safe=True,
    )
```

**Impact:** Future emails from this sender will be auto-archived and won't appear in "Needs Review" tab.

### 3. Settings Page (`/settings/senders`)

**File:** `apps/web/src/pages/SettingsSendersPage.tsx`

**Features:**
- 📋 Table view of all sender overrides
- ➕ Manually add mute/safe rules
- ❌ Remove overrides (undo)
- 🏷️ Badge indicators (Safe/Muted)

**UI Components:**
- shadcn/ui `Input`, `Button`, `Badge`
- Responsive table with hover states
- Empty state messaging

**Route:** Added to `App.tsx` as `/settings/senders`

### 4. Insights Panel

**Location:** `InboxWithActions.tsx` (above tabs)

**Metrics Displayed:**
- 📊 Quarantined emails count
- 📊 Archived emails count
- 📊 Muted senders count
- 📊 Safe senders count

**Backend:** New endpoint `GET /api/actions/metrics/summary`

**Implementation:**
```typescript
useEffect(() => {
  fetchInboxSummary()
    .then((data) => setSummary(data))
    .catch(() => {})
}, [])
```

Provides instant visibility into classification impact and user actions.

---

## 🏗️ Architecture Changes

### Backend

1. **New Router:** `senders.py` wired into `main.py`
   ```python
   from .routers import senders
   app.include_router(senders.router, prefix="/api")
   ```

2. **mark_safe Enhancement:** Now calls `upsert_sender_override()` after archiving

3. **Metrics Endpoint:** Aggregates counts from ES + overrides store

### Frontend

1. **New Page:** `SettingsSendersPage.tsx`
2. **New API Helpers:** `fetchSenderOverrides()`, `muteSender()`, `safeSender()`, `deleteSenderOverride()`
3. **Insights Card:** Lightweight metrics display in `InboxWithActions`
4. **Route:** `/settings/senders` registered in `App.tsx`

---

## 🧪 Testing Checklist

### Sender Overrides

- [ ] Mark email as safe in Inbox Actions
- [ ] Visit `/settings/senders` - see new override
- [ ] Manually add a sender override (mute mode)
- [ ] Delete an override
- [ ] Check empty state when no overrides

### Adaptive Classification

- [ ] Mark sender as safe
- [ ] Check ES document has `user_overrode_safe=true`
- [ ] Check override exists in `/api/settings/senders`
- [ ] Future emails from this sender should auto-archive (requires new email ingestion)

### Insights Panel

- [ ] Visit `/inbox-actions`
- [ ] Verify metrics card shows 4 numbers
- [ ] Quarantine an email → metric increases
- [ ] Archive an email → metric increases
- [ ] Mute a sender → muted_senders increases
- [ ] Safe a sender → safe_senders increases

---

## 📊 API Endpoints Summary

| Method | Endpoint | Purpose |
|--------|----------|---------|
| `GET` | `/api/settings/senders` | List all overrides |
| `POST` | `/api/settings/senders/mute` | Mute sender |
| `POST` | `/api/settings/senders/safe` | Mark sender safe |
| `DELETE` | `/api/settings/senders/:id` | Remove override |
| `GET` | `/api/actions/metrics/summary` | Get inbox metrics |

---

## 🔮 Future Enhancements

### Phase 1: Persistence (High Priority)
- [ ] Migrate overrides store to Postgres table
- [ ] Schema: `user_sender_overrides(id, user_id, sender, muted, safe, created_at, updated_at)`
- [ ] Use existing DB session/ORM pattern

### Phase 2: Ingestion Integration
- [ ] On email ingestion, check sender overrides
- [ ] If `safe=true`, set `risk_score=5`, `archived=true`
- [ ] If `muted=true`, set `archived=true`, `muted=true`
- [ ] Apply overrides during backfill

### Phase 3: Domain Support
- [ ] Allow overrides for entire domains (e.g., `@example.com`)
- [ ] Wildcard matching in override lookup
- [ ] UI: show "domain" badge vs "exact email"

### Phase 4: Analytics
- [ ] Track: "How many emails auto-archived via overrides?"
- [ ] Track: "Most frequently muted domains"
- [ ] Display in insights panel

---

## 🚀 Deployment

### Build & Push
```bash
docker build -f services/api/Dockerfile.prod -t leoklemet/applylens-api:v0.4.32 services/api
docker build -f apps/web/Dockerfile.prod -t leoklemet/applylens-web:v0.4.32 apps/web
docker push leoklemet/applylens-api:v0.4.32
docker push leoklemet/applylens-web:v0.4.32
```

### Deploy
```bash
docker compose -f docker-compose.prod.yml pull api web
docker compose -f docker-compose.prod.yml up -d --force-recreate api web
```

### Verify
```bash
docker logs applylens-api-prod --tail 20
```

Should see: "Scheduler started successfully" (no errors)

---

## 📝 Version Notes

- **API Image:** `leoklemet/applylens-api:v0.4.32`
- **Web Image:** `leoklemet/applylens-web:v0.4.32`
- **Previous Version:** v0.4.31 (actionability fix)
- **Breaking Changes:** None
- **Migration Required:** None (in-memory store for now)

---

## 🐛 Known Issues

1. **In-Memory Store:** Overrides reset on API restart
   - **Workaround:** Persist to Postgres in next release
   - **Impact:** Low (prod API rarely restarts)

2. **No Domain Matching:** Only exact email matches
   - **Workaround:** Manually add each sender
   - **Fix:** Planned for Phase 3

3. **No Bulk Import:** Can't upload CSV of muted senders
   - **Workaround:** Manual entry via UI
   - **Future:** Add bulk import endpoint

---

## 📚 Related Docs

- [v0.4.31 Deployment](./v0.4.31-hotfix.md) - Actionability fix
- [v0.4.30 Deployment](./v0.4.30-deployment.md) - Status chips + restore
- [v0.4.29 Deployment](./v0.4.29-deployment.md) - Lifecycle views

---

## 🎓 Learning Points

1. **Adaptive UX:** User actions teach the system (safe senders)
2. **Progressive Enhancement:** In-memory → Postgres later
3. **Visibility:** Insights panel shows value created
4. **Undo:** Settings page enables mistake recovery

---

**Status:** ✅ Deployed to production
**Next Steps:** Test in production, monitor metrics, plan Postgres migration
