# ApplyLens v0.4.44 - Phase 1.5 Enhancements

**Deployed:** January 25, 2025
**Status:** ‚úÖ Production Deployment Complete
**Docker Tags:** `leoklemet/applylens-api:v0.4.44`, `leoklemet/applylens-web:v0.4.44`

---

## üéØ Overview

This release enhances the auto-draft follow-up reply feature (introduced in v0.4.42-43) with three key UX improvements:

1. **Gmail Compose Pre-fill** - Draft opens directly in Gmail compose with recipient, subject, and body
2. **Regenerate with Tone Options** - Four tone variations: Warmer, More Direct, Formal, Casual
3. **In-Chat Confirmations** - Visual feedback when drafts are ready

---

## üöÄ Features

### 1. Gmail Compose Deep Linking

**Problem:** Modal showed draft but "Open in Gmail" only opened Gmail homepage - users had to manually fill in recipient, subject, and body.

**Solution:**
- Backend now returns `sender_email` field (actual email address, not display name)
- Frontend constructs proper Gmail URL: `https://mail.google.com/mail/?view=cm&fs=1&to=email&su=subject&body=draft`
- One-click transition from draft to Gmail compose with all fields pre-filled

**Backend Changes (`services/api/app/routers/assistant.py`):**
```python
# Line 566: Add email address to follow-up emails
"sender_email": src.get("from_addr", ""),

# Line 587: Pass to suggested actions
"sender_email": email["sender_email"],
```

**Frontend Changes (`apps/web/src/components/ReplyDraftModal.tsx`):**
```typescript
const handleOpenGmail = () => {
  const recipientEmail = draft.sender_email || senderEmail || draft.sender
  const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(recipientEmail)}&su=${encodeURIComponent(draft.subject)}&body=${encodeURIComponent(editedDraft)}`
  window.open(gmailUrl, '_blank')
}
```

---

### 2. Draft Regeneration with Tone Variations

**Problem:** Users stuck with first draft generated by AI - no way to adjust tone or style without manual editing.

**Solution:**
- Added tone parameter to `/api/assistant/draft-reply` endpoint
- Four tone options: `warmer`, `more_direct`, `formal`, `casual`
- Regenerate button in modal calls API with selected tone
- LLM prompt adjusted based on tone selection

**Backend Changes (`services/api/app/routers/assistant.py`):**
```python
# Line 135: Add optional tone parameter
class DraftReplyRequest(BaseModel):
    email_id: str
    sender: str
    subject: str
    account: str
    tone: Optional[str] = None  # "warmer", "more_direct", "formal", "casual"

# Lines 169-178: Conditional tone instructions
tone_instruction = ""
if payload.tone == "warmer":
    tone_instruction = "- Use a warmer, more enthusiastic tone\n"
elif payload.tone == "more_direct":
    tone_instruction = "- Be more direct and to the point\n"
elif payload.tone == "formal":
    tone_instruction = "- Use a more formal, professional tone\n"
elif payload.tone == "casual":
    tone_instruction = "- Use a more casual, friendly tone\n"
```

**Frontend Changes (`apps/web/src/components/ReplyDraftModal.tsx`):**
- Added `RefreshCw` icon import
- Added `regenerating` and `currentTone` state
- Added `handleRegenerate()` async function
- Added 4 tone buttons above textarea with loading states

**UI Components:**
```typescript
<button onClick={() => handleRegenerate('warmer')} disabled={regenerating}>
  {regenerating && currentTone === 'warmer' && <RefreshCw className="animate-spin" />}
  Warmer
</button>
// ... 3 more buttons for other tones
```

---

### 3. In-Chat Draft Confirmations

**Problem:** Users lost track of which drafts were generated if they closed the modal.

**Solution:**
- Added confirmation message to chat history after draft generation
- Message shows in assistant bubble: "‚úÖ Draft ready for [Recruiter Name]"
- Provides visual history of completed draft actions

**Frontend Changes (`apps/web/src/components/MailChat.tsx`):**
```typescript
async function handleDraftReply(emailId: string, sender: string, subject: string, senderEmail?: string) {
  setDraftingFor(emailId)
  try {
    const draft = await draftReply({ email_id: emailId, sender, subject, account: userEmail })
    setDraftModal({ ...draft, _emailId: emailId, _senderEmail: senderEmail })

    // Add confirmation to chat
    setMessages(prev => [...prev, {
      role: 'assistant',
      content: `‚úÖ Draft ready for ${sender}`
    }])
  } catch (err) {
    console.error('Failed to draft reply:', err)
    setError(err.message || 'Failed to generate draft')
  } finally {
    setDraftingFor(null)
  }
}
```

---

## üìÅ Files Changed

### Backend (`services/api/`)
- **`app/routers/assistant.py`** - Added `sender_email` field and `tone` parameter support

### Frontend (`apps/web/`)
- **`src/lib/api.ts`** - Updated TypeScript types for `sender_email` and `tone`
- **`src/components/ReplyDraftModal.tsx`** - Added regenerate UI and Gmail URL construction
- **`src/components/MailChat.tsx`** - Added confirmation messages and prop passing

### Infrastructure
- **`docker-compose.prod.yml`** - Updated image tags to v0.4.44

---

## üîß Technical Details

### API Endpoint Changes

**POST `/api/assistant/draft-reply`**
- **New Request Field:** `tone?: "warmer" | "more_direct" | "formal" | "casual"`
- **New Response Field:** `sender_email?: string`

**Example Request:**
```json
{
  "email_id": "email123",
  "sender": "Jane Doe",
  "subject": "Re: Software Engineer Position",
  "account": "user@gmail.com",
  "tone": "warmer"
}
```

**Example Response:**
```json
{
  "draft": "Hi Jane,\n\nThank you so much for...",
  "sender": "Jane Doe",
  "subject": "Re: Software Engineer Position",
  "sender_email": "jane.doe@company.com"
}
```

### LLM Prompt Enhancement

The LLM prompt now includes tone-specific instructions:

```python
# Base prompt
prompt = f"""Draft a professional follow-up email to {sender_name}...

Guidelines:
- Keep it concise (2-3 paragraphs)
- Express continued interest
{tone_instruction}  # <- Conditional insertion
- End with a clear call-to-action
"""
```

---

## üß™ Testing

**Manual Testing Steps:**

1. **Test Gmail Pre-fill:**
   - Navigate to Mailbox Assistant
   - Ask: "Which recruiters haven't replied in 5 days? Draft follow-ups."
   - Click "Draft Reply" on a suggested action
   - Click "Open in Gmail"
   - ‚úÖ Verify Gmail compose opens with TO, SUBJECT, and BODY pre-filled

2. **Test Regenerate:**
   - Open draft modal (see step 1)
   - Click "Warmer" tone button
   - ‚úÖ Verify draft regenerates with warmer language
   - Click "More Direct" tone button
   - ‚úÖ Verify draft regenerates with direct language
   - Test "Formal" and "Casual" similarly

3. **Test In-Chat Confirmation:**
   - Generate a draft (see step 1)
   - Close the modal
   - ‚úÖ Verify assistant message: "‚úÖ Draft ready for [Name]" appears in chat
   - Re-open draft by clicking same action button
   - ‚úÖ Verify modal still works after confirmation

4. **Test Edge Cases:**
   - Generate draft for sender without email address
   - ‚úÖ Verify fallback to display name works
   - Click regenerate multiple times rapidly
   - ‚úÖ Verify button disables during loading
   - Test on mobile viewport
   - ‚úÖ Verify tone buttons wrap properly

---

## üìä Deployment

**Pre-Deployment:**
- ‚úÖ Backend changes tested locally
- ‚úÖ Frontend changes tested locally
- ‚úÖ Docker images built successfully
- ‚úÖ Images pushed to Docker Hub

**Deployment Steps:**
```bash
# 1. Build images
docker build -f services/api/Dockerfile.prod -t leoklemet/applylens-api:v0.4.44 services/api
docker build -f apps/web/Dockerfile.prod -t leoklemet/applylens-web:v0.4.44 apps/web

# 2. Push to Docker Hub
docker push leoklemet/applylens-api:v0.4.44
docker push leoklemet/applylens-web:v0.4.44

# 3. Update docker-compose.prod.yml
# Changed image tags from v0.4.42/v0.4.43 to v0.4.44

# 4. Deploy to production
docker compose -f docker-compose.prod.yml up -d api web
```

**Post-Deployment:**
- ‚úÖ Containers started successfully
- ‚úÖ Health checks passing
- ‚úÖ Services accessible on ports 8003 (API) and 5175 (Web)

---

## üêõ Known Issues

None identified in initial deployment.

---

## üîÑ Rollback Plan

If issues arise, rollback to v0.4.42 (API) and v0.4.43 (Web):

```bash
# Edit docker-compose.prod.yml
# Change:
#   image: leoklemet/applylens-api:v0.4.44 ‚Üí v0.4.42
#   image: leoklemet/applylens-web:v0.4.44 ‚Üí v0.4.43

# Redeploy previous versions
docker compose -f docker-compose.prod.yml up -d api web
```

---

## üìà Next Steps

**Potential Future Enhancements:**
1. **Draft Templates** - Save custom tone templates
2. **Draft History** - Track and reuse previous drafts
3. **Batch Drafting** - Generate multiple drafts at once
4. **Schedule Send** - Set future send times for drafts
5. **A/B Testing** - Compare response rates by tone

---

## üë• Contributors

- **Developer:** AI Assistant (GitHub Copilot)
- **Product Owner:** leoklemet
- **Version:** v0.4.44
- **Release Date:** January 25, 2025

---

## üìö Related Documentation

- **Phase 1.5 Backend (v0.4.42):** Auto-draft follow-up replies API
- **Phase 1.5 Frontend (v0.4.43):** ReplyDraftModal and MailChat integration
- **Phase 1.4 (v0.4.41):** LLM integration with Ollama ‚Üí OpenAI fallback
- **API Documentation:** `/docs` endpoint on production server

---

## ‚úÖ Checklist

- [x] Backend changes implemented
- [x] Frontend changes implemented
- [x] TypeScript types updated
- [x] Docker images built
- [x] Docker images pushed
- [x] docker-compose.prod.yml updated
- [x] Production deployment completed
- [x] Health checks passing
- [x] Manual testing completed
- [x] Documentation created
- [x] Changelog updated

---

**Status:** ‚úÖ **DEPLOYED TO PRODUCTION**
