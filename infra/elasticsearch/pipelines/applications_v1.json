{
  "description": "ApplyLens applications normalization v1",
  "processors": [
    {"lowercase": {"field": "company", "ignore_missing": true}},
    {"trim": {"field": "company", "ignore_missing": true}},
    {"rename": {"field": "status", "target_field": "status_raw", "ignore_missing": true, "ignore_failure": true}},
    {"lowercase": {"field": "status_raw", "ignore_missing": true}},
    {"set": {"field": "archived", "value": false}},
    {"script": {
      "lang": "painless",
      "source": "ctx.archived = (ctx.containsKey('archived_at') && ctx.archived_at != null); ctx.deleted = (ctx.containsKey('deleted_at') && ctx.deleted_at != null);"
    }},
    {"date": {"field": "applied_at", "formats": ["ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSX"], "ignore_failure": true}},
    {"date": {"field": "archived_at", "formats": ["ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSX"], "ignore_failure": true}},
    {"date": {"field": "deleted_at", "formats": ["ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSX"], "ignore_failure": true}},
    {"set": {"field": "status_archived", "value": "{{#ctx.archived}}archived{{/ctx.archived}}{{^ctx.archived}}active{{/ctx.archived}}"}},
    {"remove": {"field": ["_temp", "status"], "ignore_missing": true}}
  ],
  "on_failure": [
    {"set": {"field": "_ingest_error", "value": "{{_ingest.on_failure_message}}"}}
  ]
}
