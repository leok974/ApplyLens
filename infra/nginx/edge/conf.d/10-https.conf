# Common
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}
resolver 127.0.0.11 ipv6=off;

########################
# ApplyLens – Web app
########################
server {
  listen 443 ssl http2;
  server_name applylens.app;

  ssl_certificate     /etc/letsencrypt/live/applylens.app/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/applylens.app/privkey.pem;

  include /etc/nginx/snippets/proxy_headers.conf;

  # Static assets can be cached by CF; origin sends ETags.
  location / {
    proxy_pass http://applylens-web:80;
  }

  # Pass ACME path even on HTTPS just in case
  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  # Health endpoint (optional pass-through)
  location = /healthz {
    proxy_pass http://applylens-api:8003/healthz;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
  }
}

########################
# ApplyLens – API
########################
server {
  listen 443 ssl http2;
  server_name api.applylens.app;

  ssl_certificate     /etc/letsencrypt/live/api.applylens.app/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/api.applylens.app/privkey.pem;

  include /etc/nginx/snippets/proxy_headers.conf;

  location / {
    proxy_pass http://applylens-api:8003;
  }

  location = /healthz {
    proxy_pass http://applylens-api:8003/healthz;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
  }

  # CORS preflight handling
  location @cors_preflight {
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
    add_header Access-Control-Allow-Headers "*" always;
    add_header Access-Control-Max-Age 86400 always;
    add_header Content-Type "text/plain charset=UTF-8" always;
    add_header Content-Length 0 always;
    return 204;
  }
}

########################
# # AI-finance / Ledger-Mind
# ########################
# server {
#   listen 443 ssl http2;
#   server_name assistant.ledger-mind.org;
#
#   ssl_certificate     /etc/letsencrypt/live/assistant.ledger-mind.org/fullchain.pem;
#   ssl_certificate_key /etc/letsencrypt/live/assistant.ledger-mind.org/privkey.pem;
#
#   include /etc/nginx/snippets/proxy_headers.conf;
#
#   location / {
#     proxy_pass http://ledger-web:80;
#   }
#
#   location ^~ /.well-known/acme-challenge/ {
#     root /var/www/certbot;
#   }
# }
