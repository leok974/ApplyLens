# ApplyLens Local Dev - Same-Origin Configuration
# All traffic on port 80, proxied to appropriate backend services

server {
  listen 80 default_server;
  server_name _;

  # Sanity limits
  client_max_body_size 25m;
  proxy_connect_timeout 10s;
  proxy_send_timeout    120s;
  proxy_read_timeout    120s;
  proxy_buffers         16 32k;
  proxy_buffer_size     64k;

  # Health check endpoint for Docker healthcheck
  location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
  }

  # /api → FastAPI backend (service: api, port: 8003)
  location /api/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;

    # Remove /api prefix when forwarding to backend
    rewrite ^/api/(.*)$ /$1 break;
    proxy_pass http://api:8003/;
  }

  # Everything else → Vite dev server (service: web, port: 5175)
  location / {
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_set_header Upgrade            $http_upgrade;
    proxy_set_header Connection         "upgrade";

    # Vite HMR WebSocket support
    proxy_http_version 1.1;

    proxy_pass http://web:5175;
  }
}
