# /etc/nginx/conf.d/applylens.conf
# Path-based routing for ApplyLens services

# WebSocket upgrade map
map $http_upgrade $connection_upgrade { 
  default upgrade; 
  '' close; 
}

server {
  listen 80 default_server;
  server_name applylens.app www.applylens.app;

  # --- Basic hardening & gzip ---
  include /etc/nginx/snippets/security-headers.conf;
  include /etc/nginx/snippets/gzip.conf;
  client_max_body_size 25m;
  sendfile on;

  # --- Health check ---
  location = /healthz { 
    return 200 "ok\n"; 
    add_header Content-Type text/plain;
  }

  # --- SEO files ---
  location = /robots.txt {
    return 200 "User-agent: *\nAllow: /\n";
    add_header Content-Type text/plain;
  }

  location = /sitemap.xml {
    return 200 "<?xml version='1.0' encoding='UTF-8'?><urlset xmlns='http://www.sitemaps.org/schemas/sitemap/0.9'><url><loc>https://applylens.app/</loc></url></urlset>";
    add_header Content-Type application/xml;
  }

  # --- 1) Redirect root to web app ---
  location = / {
    return 302 /web/;
  }

  # --- 2) Web App (Vite/React SPA) under /web/ ---
  location /web/ {
    # Normalize /web -> /web/
    if ($request_uri = "/web") {
      return 301 /web/;
    }

    proxy_pass http://web:5175/;
    include /etc/nginx/snippets/proxy.ws;
  }

  # --- 3) API Endpoints ---
  location /docs/ {
    proxy_pass http://api:8003/docs/;
    include /etc/nginx/snippets/proxy.common;
  }

  location /openapi.json {
    proxy_pass http://api:8003/openapi.json;
    include /etc/nginx/snippets/proxy.common;
  }

  # API root (careful: this catches everything not matched above)
  location / {
    proxy_pass http://api:8003/;
    include /etc/nginx/snippets/proxy.ws;
    proxy_read_timeout 300;
  }

  # --- 4) Monitoring & Observability ---
  location /grafana/ {
    proxy_pass http://grafana:3000/;
    proxy_set_header X-Forwarded-Prefix /grafana;
    include /etc/nginx/snippets/proxy.ws;
  }

  location /kibana/ {
    rewrite ^/kibana/(.*)$ /$1 break;
    proxy_pass http://kibana:5601/kibana/;
    include /etc/nginx/snippets/proxy.ws;
  }

  location /prometheus/ {
    proxy_pass http://prometheus:9090/;
    include /etc/nginx/snippets/proxy.common;
  }
}
