# /etc/nginx/conf.d/applylens.conf
# Path-based routing for ApplyLens services
map $http_upgrade $connection_upgrade { 
  default upgrade; 
  '' close; 
}

server {
  listen 80;
  server_name applylens.app www.applylens.app;

  # --- Basic hardening & gzip ---
  include /etc/nginx/snippets/security-headers.conf;
  include /etc/nginx/snippets/gzip.conf;
  client_max_body_size 25m;
  sendfile on;

  # --- Health check ---
  location = /healthz { 
    return 200 "ok\n"; 
    add_header Content-Type text/plain;
  }

  # --- Root -> API (FastAPI) ---
  location / {
    proxy_pass         http://api:8003/;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
    proxy_read_timeout 300;
  }

  # /docs (FastAPI Swagger) flows through from API
  location /docs/ {
    proxy_pass         http://api:8003/docs/;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  # /openapi.json (FastAPI OpenAPI spec) flows through from API
  location /openapi.json {
    proxy_pass         http://api:8003/openapi.json;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  # --- Web (Vite/React) under /web/ ---
  location /web/ {
    proxy_pass         http://web:5175/;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
  }

  # --- Prometheus under /prometheus/ ---
  location /prometheus/ {
    proxy_pass         http://prometheus:9090/;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  # --- Grafana under /grafana/ (requires grafana.ini config) ---
  location /grafana/ {
    proxy_pass         http://grafana:3000/;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
  }

  # --- Kibana under /kibana/ (requires kibana.yml config) ---
  location /kibana/ {
    proxy_pass         http://kibana:5601/;
    proxy_set_header   Host $host;
    proxy_set_header   X-Real-IP $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection $connection_upgrade;
  }
}
