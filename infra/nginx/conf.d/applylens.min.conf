# Minimal vhost for CF Tunnel → nginx (internal) → web/api (internal)
resolver 127.0.0.11 ipv6=off;

upstream app_web { server web:80; keepalive 32; }
# If your API service is actually named 'api', use 'api:8003' here.
upstream app_api { server api:8003; keepalive 32; }

server {
  listen 80 default_server;
  server_name _;

  # Web
  location / {
    proxy_pass http://app_web;
    include /etc/nginx/snippets/proxy_headers.conf;
  }

  # API (prefix preserved)
  location /api/ {
    proxy_pass http://app_api/;
    include /etc/nginx/snippets/proxy_headers.conf;
  }

  # Health passthrough (API exposes /healthz)
  location = /healthz {
    proxy_pass http://app_api/healthz;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }

  # API health with prefix
  location = /api/healthz {
    proxy_pass http://app_api/healthz;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
    add_header Pragma "no-cache";
    add_header Expires "0";
  }
}
