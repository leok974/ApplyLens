services:
  cfd-a:
    image: cloudflare/cloudflared:latest
    container_name: cfd-a
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARED_TUNNEL_TOKEN}
    networks:
      - infra_net
      - applylens_applylens-prod
    restart: unless-stopped
    # Healthcheck disabled: cloudflared image lacks shell utilities
    # Tunnel status is visible in logs via "Registered tunnel connection" messages

  # DISABLED 2025-11-21: DNS resolution failures for applylens-web-prod and applylens-api-prod
  # Caused intermittent 502 errors when Cloudflare load-balanced requests to this connector
  # cfd-b:
  #   image: cloudflare/cloudflared:latest
  #   container_name: cfd-b
  #   command: tunnel run
  #   environment:
  #     - TUNNEL_TOKEN=${CLOUDFLARED_TUNNEL_TOKEN}
  #   networks:
  #     - infra_net
  #     - applylens_applylens-prod
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pgrep cloudflared || exit 1"]
  #     interval: 30s
  #     timeout: 5s
  #     retries: 3

networks:
  infra_net:
    external: true
  applylens_applylens-prod:
    external: true
