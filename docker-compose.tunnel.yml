services:
  cfd-a:
    image: cloudflare/cloudflared:latest
    container_name: cfd-a
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARED_TUNNEL_TOKEN}
    networks:
      - infra_net
      - applylens_applylens-prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep cloudflared || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  cfd-b:
    image: cloudflare/cloudflared:latest
    container_name: cfd-b
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARED_TUNNEL_TOKEN}
    networks:
      - infra_net
      - applylens_applylens-prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep cloudflared || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  infra_net:
    external: true
  applylens_applylens-prod:
    external: true
